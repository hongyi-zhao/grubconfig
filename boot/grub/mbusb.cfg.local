
    insmod part_msdos
    insmod ntfs
	
    insmod part_gpt
    insmod ext2
    insmod iso9660
    insmod regexp
    insmod loopback
        
    insmod chain

unset cd_label_tot

for i in (*)/EFI/* (*)/efi/* (*)/boot/*; do
       
        regexp -s rootdev '^(\(.*\))' "$i"

        probe --set fs --fs "$rootdev"
        if [ x$fs = xiso9660 ]; then
        
          probe --set cd_label --label "$rootdev"

          for file in $i/GRUBX64.* $i/grubx64.*; do
           if regexp -s 1:loader_path -s 2:loader_name '^\(.*\)(/.*/([^/]+(efi|EFI)))$' "$file"; then
               
                if regexp "$cd_label" "$cd_label_tot"; then continue; fi
                cd_label_tot="${cd_label_tot} ${cd_label}"
                
                menuentry "$cd_label on $rootdev ($loader_name/ddrescue/partclone.dd) ->" "$rootdev" "$loader_path" {
                root=$2
                chainloader $3
              }  
       
           fi          
         
         done

         
         for file in $i/BOOTX64.* $i/bootx64.*; do
        
           if regexp -s 1:loader_path -s 2:loader_name '^\(.*\)(/.*/([^/]+(efi|EFI)))$' "$file"; then
           
                if regexp "$cd_label" "$cd_label_tot"; then continue; fi
                cd_label_tot="${cd_label_tot} ${cd_label}"
           
                menuentry "$cd_label on $rootdev ($loader_name/ddrescue/partclone.dd) ->" "$rootdev" "$loader_path" {
                root=$2
                chainloader $3
              }  
       
           fi         
         
         done
         
         # for Freebsd
          for file in $i/loader.efi; do
        
           if regexp -s 1:loader_path -s 2:loader_name '^\(.*\)(/.*/([^/]+(efi|EFI)))$' "$file"; then
           
                if regexp "$cd_label" "$cd_label_tot"; then continue; fi
                cd_label_tot="${cd_label_tot} ${cd_label}"
           
                menuentry "$cd_label on $rootdev ($loader_name/ddrescue/partclone.dd) ->" "$rootdev" "$loader_path" {
                root=$2
                chainloader $3
              }  
       
           fi         
         
         done        
         
          # for Microsoft Windows           
          elif [ x$fs = xntfs ]; then
          
           for file in $i/BOOTX64.* $i/bootx64.*; do
        
             if regexp -s 1:loader_path -s 2:loader_name '^\(.*\)(/.*/([^/]+(efi|EFI)))$' "$file"; then
           
                 if regexp "Microsoft Windows" "$cd_label_tot"; then continue; fi
                 cd_label_tot="${cd_label_tot} Microsoft Windows"
                
                menuentry "Windows on $rootdev ($loader_name/ddrescue/partclone.dd) ->" "$rootdev" "$loader_path" {
                root=$2
                chainloader $3
              }  
       
             fi         
         
           done
            
        fi 
           
         
done

