man grub-mkimage 有下面的选项：

       -m,                              --memdisk=FILE
              embed FILE as a memdisk image

       Implies `-p (memdisk)/boot/grub' and overrides

       any prefix supplied previously, but the prefix
              itself can be overridden by later options

这正是 grub-mkstandalone 基于 grub-mkimage 的工作方式。

在这个处理过程中，root=(memdisk)， prefix=(memdisk)/boot/grub

但是，我的相关文件位于 硬盘，仍然要变化 相应的 root 、prefix 。

具体 ref 本目录下 grub.cfg中的说明。


首先要 sudo make install 自己编译的grub，然后：

经过测试，加载下面的这些模块：

grub-mkstandalone -O x86_64-efi -o grub-mkstandalone-x86_64.efi --modules='boot chain configfile disk diskfilter echo eval ext2 fat file hdparm hello help hexdump iso9660 jfs loopback memdisk nativedisk newc normal ntfs ntfscomp odc part_bsd part_gpt part_msdos parttool probe procfs progress read reboot regexp reiserfs romfs scsi search search_fs_file search_fs_uuid search_label sleep sleep_test squash4 syslinuxcfg tar test tr trig true udf xfs xzio zfs zfscrypt zfsinfo zstd' boot/grub/grub.cfg=./grub-mkstandalone.cfg






grub2的核心是 grub-mkimage， google如下：

grub-mkimage memdisk

下面有一些具体用法：

https://stackoverflow.com/questions/18212050/using-grub-is-it-possible-to-use-if-while-during-booting-before-loading-nor

https://github.com/hongyi-zhao/grub2-filemanager


基于 grub-mkstandalone 的方法内部也是调用 grub-mkimage 的，如下：


werner@debian:~$ sudo grub-mkstandalone -O x86_64-efi -o grub-mkstandalone-x86_64.efi --modules='fat part_msdos part_gpt ext2 regexp iso9660 loopback chain search configfile test normal'  boot/grub/grub.cfg=./grub-mkstandalone.cfg -v |& grep -E 'grub-mkimage'
grub-mkstandalone: info: grub-mkimage --directory '/usr/lib/grub/x86_64-efi' --prefix '(memdisk)/boot/grub' --output 'grub-mkstandalone-x86_64.efi' --format 'x86_64-efi' --compression 'auto'  --memdisk '/tmp/grub.wXtx3a' 'fat' 'part_msdos' 'part_gpt' 'ext2' 'regexp' 'iso9660' 'loopback' 'chain' 'search' 'configfile' 'test' 'normal' 'memdisk' 'tar'


尝试用 strace 跟踪，也没有发现太多有用的信息：

sudo strace -f -o out grub-mkstandalone -O x86_64-efi -o grub-mkstandalone-x86_64.efi --modules='fat part_msdos part_gpt ext2 regexp iso9660 loopback chain search configfile test normal'  boot/grub/grub.cfg=./grub-mkstandalone.cfg
 

使用下面的方法预加载全模块：
这个想法是错误的，会导致无法引导成功。加载了不必要的模块，反而造成问题。

find /usr/local/lib/grub/x86_64-efi -type f -name *.mod | xargs -n1 -P0 basename | sed 's/[.]mod$//' | xargs 

acpi adler32 affs afs ahci all_video aout appleldr archelp ata at_keyboard backtrace bfs biosdisk bitmap bitmap_scale blocklist boot bsd bswap_test btrfs bufio cat cbfs cbls cbmemc cbtable cbtime chain cmdline_cat_test cmosdump cmostest cmp cmp_test configfile cpio cpio_be cpuid crc64 crypto cryptodisk cs5536 ctz_test date datehook datetime disk diskfilter div div_test dm_nv drivemap echo efiemu efifwsetup efi_gop efinet efi_uga ehci elf eval exfat exfctest ext2 extcmd f2fs fat file fixvideo font freedos fshelp functional_test gcry_arcfour gcry_blowfish gcry_camellia gcry_cast5 gcry_crc gcry_des gcry_dsa gcry_idea gcry_md4 gcry_md5 gcry_rfc2268 gcry_rijndael gcry_rmd160 gcry_rsa gcry_seed gcry_serpent gcry_sha1 gcry_sha256 gcry_sha512 gcry_tiger gcry_twofish gcry_whirlpool gdb geli gettext gfxmenu gfxterm gfxterm_background gfxterm_menu gptsync gzio halt hashsum hdparm hello help hexdump hfs hfsplus hfspluscomp http iorw iso9660 jfs jpeg keylayouts keystatus ldm legacycfg legacy_password_test linux linux16 loadbios loadenv loopback ls lsacpi lsapm lsefi lsefimmap lsefisystab lsmmap lspci lssal luks lvm lzopio macbless macho mda_text mdraid09 mdraid09_be mdraid1x memdisk memrw minicmd minix minix2 minix2_be minix3 minix3_be minix_be mmap morse mpi msdospart mul_test multiboot multiboot2 nativedisk net newc nilfs2 normal ntfs ntfscomp ntldr odc offsetio ohci part_acorn part_amiga part_apple part_bsd part_dfly part_dvh part_gpt part_msdos part_plan part_sun part_sunpc parttool password password_pbkdf2 pata pbkdf2 pbkdf2_test pci pcidump pgp plan9 play png priority_queue probe procfs progress pxe pxechain raid5rec raid6rec random rdmsr read reboot regexp reiserfs relocator romfs scsi search search_fs_file search_fs_uuid search_label sendkey serial setjmp setjmp_test setpci sfs shift_test shim_lock signature_test sleep sleep_test spkmodem squash4 strtoull_test syslinuxcfg tar terminal terminfo test test_blockarg testload testspeed tftp tga time tpm tr trig true truecrypt udf ufs1 ufs1_be ufs2 uhci usb usb_keyboard usbms usbserial_common usbserial_ftdi usbserial_pl2303 usbserial_usbdebug usbtest vbe verifiers vga vga_text video video_bochs video_cirrus video_colors video_fb videoinfo videotest videotest_checksum wrmsr xfs xnu xnu_uuid xnu_uuid_test xzio zfs zfscrypt zfsinfo zstd




